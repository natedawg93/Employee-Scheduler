<!DOCTYPE html>
<html>
<head>
	<title>Table From Knack</title>
	<meta charset='utf-8' />
	<link href="https://unpkg.com/tabulator-tables@4.2.7/dist/css/tabulator.min.css" rel="stylesheet"><!--tabulator css-->
	<script type="text/javascript" src="https://unpkg.com/tabulator-tables@4.2.7/dist/js/tabulator.min.js"></script><!--tabulator js-->
	<script src="https://code.jquery.com/jquery-3.4.1.js"></script> <!--jquery cdn-->
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"> <!--bootstrap css-->
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script> <!--bootstrap js-->
	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script> <!--jquery UI-->
	<script src='https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js'></script> <!--moment js-->
	<script src='https://unpkg.com/json-groupby@1.1.0/dist/json-groupby.js'></script> <!--json-groupby js-->
</head>
<body>
	<form id="date-range">
		From:
		<input type="date" name="from" min="2015-01-01" id="from" required><br><br>
		<button type="button" class="btn btn-primary" id="date-submit">Submit</button>
	</form>
	<div id="example-table"></div>

	<script type="text/javascript">
		function groupBy(items, properties, collect) {
		  if (arguments.length < 2) return arr;
		  var groups = _groupBy(items, properties);
		  // collect other properties values in array
		  if (collect && collect.length > 0)
		    groups = collectProperties(groups, collect);

		  return groups;
		}

		function _groupBy(items, properties) {
		  var group = {};
		 	    if (typeof properties[0] === 'string') {
		 	      group = groupByCategory(items, properties[0]);
		 	    } else {
		 	      group = groupByRange(items, properties[0]);
		 	    }
		      properties = properties.slice(1);
		    if (properties.length > 0) {
		      for (var key in group) {
		        group[key] = _groupBy(group[key], properties);
		      }
		    }
		    return group;
		}
		function groupByCategory(arr, prop) {
		  var isPropertyArray = Array.isArray(valueAt(arr[0], prop));
		  if (isPropertyArray) {
		    return arr.reduce(function(group, f) {
		      var tags = valueAt(f, prop);
		      tags.forEach(function(tag) { 
		        group[tag] = group[tag] || [];
		        group[tag].push(f);
		      });
		      return group;
		    },{});
		  } else {
		    return arr.reduce(function(group, f) {
		      var tag = valueAt(f, prop);
		      group[tag] = group[tag] || [];
		      group[tag].push(f);
		      return group;
		    },{});
		  }
		}
		function valueAt(obj,path) {
		  //taken from http://stackoverflow.com/a/6394168/713573
		  function index(prev,cur, i, arr) { 
		    if (prev.hasOwnProperty(cur)) {
		      return prev[cur]; 
		    } else {
		      throw new Error(arr.slice(0,i+1).join('.') + ' is not a valid property path'); 
		    }
		  }
		  return path.split('.').reduce(index, obj);
		}



		function getAllRecordsForObject(sceneKey, viewKey, callbackFunctionToHandleData,start, end, currentPage = 1, totalPages, allRecordsForObject = []) {
		  if (!sceneKey || !viewKey) {
		    throw new Error('Missing scene or view key!');
		  }

		  if (!callbackFunctionToHandleData) {
		    throw new Error('No callback function provided; make sure the data is handled somehow.');
		  }
		  // AJAX prep
		  var url = 'https://api.knack.com/v1/pages/' + sceneKey + '/views/' + viewKey + '/records?page=' + currentPage + '&rows_per_page=1000';
		  var headers = {
		    'X-Knack-Application-ID': '5c93c4d50fbcdf5726ae5439',
		    'X-Knack-REST-API-Key': 'e46f6190-4bfb-11e9-9d62-3b671224caf2'
		  };

		  $.ajax({
		    url: url,
		    headers: headers,
		    type: 'GET',
		  }).done(function(responseData) {
		    allRecordsForObject = allRecordsForObject.concat(responseData.records);
		    // Recursively continue getting records until we have all of them
		    if (currentPage < responseData.total_pages) {
		      currentPage++;
		      getAllRecordsForObject(sceneKey, viewKey, callbackFunctionToHandleData, start, end, currentPage, responseData.total_pages, allRecordsForObject);
		      return;
		    }
		    // Handle ALL records with our callback function
		    callbackFunctionToHandleData(allRecordsForObject, start, end);
		  });
		};	

		function handleData(allRecordsForObject, start, end) {

			function parse_iso(iso_time){
				return String(iso_time).slice(0,-5);
			};

			function parseDate(dateStr) {
				var date = dateStr.split('/');
				var month = date[0] - 1 ; //January = 0
				var day = date[1]; 
				var year = date[2];
				return new Date(year, day, month); 
			};

			function filterDate(startDate,endDate,data){
				var filteredData = [];
				for(var index in data) {
				    var obj = data[index];
				    var date = moment(obj.field_58_raw.date,'MM/DD/YYYY').toDate();
				    if(date >= startDate && date <= endDate)
				        filteredData.push(obj);
	 			}
	        	return filteredData;
			}


	      let data = allRecordsForObject;

	      // console.log(data);
	      data = filterDate(start,end,data)
	      // console.log(data);

	      var people = []
	      var events = []
	      // var tabledata = []
	      var c = 0;
	      console.log(data)
	      for (let d of data.entries()){ // Construct the JSON payload for the calendar
	      	// console.log(d)
	        people.push({id: d[1].id, //Field_57 is the name
	                    title: d[1].field_57,
	                    children: [{
	                        id: d[1].field_57 + '_Scheduled',
	                        title: 'Scheduled',
	                      },
	                      {
	                        id: d[1].field_57 + '_Actual',
	                        title: 'Actual',
	                      }
	                    ]
	                    })
	        events.push({id: String(c) + '_Scheduled',
	                    resourceId: d[1].field_57 + '_Scheduled',
	                    start: parse_iso(d[1].field_58_raw.iso_timestamp),//Field_58 is the scheduled time. Use slice to get rid of '.000Z'
	                    end: parse_iso(d[1].field_58_raw.to.iso_timestamp),
	                    title: d[1].field_61, // Field_61 is the title (whats displayed inside the bar)
	                    color:'#7FFF00',
	                    record_id:d[1].id
	                    })
	        events.push({id: String(c) + '_Actual',
	                    resourceId: d[1].field_57 + '_Actual', 
	                    start: parse_iso(d[1].field_67_raw.iso_timestamp), //Field_67 is the actual time
	                    end: parse_iso(d[1].field_67_raw.to.iso_timestamp),
	                    title: d[1].field_61,
	                    color: '#FF0000',
	                    record_id:d[1].id
	                    })
	      //   tabledata.push({
	      //   	id:c,
	      //   	name: d[1].field_57,
	      //   	"_children":[
	      //   		{
	      //   			id:c+1, name:"Scheduled", 
	      //   			hours:"15", 
	      //   			'd1':`Cleaning: 12:00pm to 2:00pm,\nCooking: 12:00pm to 2:00pm,\nWashing the dishes: 12:00pm to 2:00pm,\nWiping the counters: 12:00pm to 2:00pm,\n12:00pm to 2:00pm,\n12:00pm to 2:00pm,\n12:00pm to 2:00pm,\n12:00pm to 2:00pm,\n`,
	      //   			'd2':"Cleaning: 12:00pm to 2:00pm,\nCooking: 12:00pm to 2:00pm,\nWashing the dishes: 12:00pm to 2:00pm,\n",
	      //   			'd3':"Cleaning: 12:00pm to 2:00pm,\nCooking: 12:00pm to 2:00pm,\nWashing the dishes: 12:00pm to 2:00pm,\nCleaning: 12:00pm to 2:00pm,\nCooking: 12:00pm to 2:00pm,\n",
	      //   			'd4':"Cleaning: 12:00pm to 2:00pm,\n",
	      //   			'd5':"Cleaning: 12:00pm to 2:00pm,\nCleaning: 12:00pm to 2:00pm,\nCleaning: 12:00pm to 2:00pm,\n",
	      //   			'd6':"Cleaning: 12:00pm to 2:00pm,\nCooking: 12:00pm to 2:00pm",
	      //   			'd7':"Cleaning: 12:00pm to 2:00pm,\nCooking: 12:00pm to 2:00pmCleaning: 12:00pm to 2:00pm,\nCooking: 12:00pm to 2:00pmCleaning: 12:00pm to 2:00pm,\nCooking: 12:00pm to 2:00pmCleaning: 12:00pm to 2:00pm,\nCooking: 12:00pm to 2:00pmCleaning: 12:00pm to 2:00pm,\nCooking: 12:00pm to 2:00pm",
	      //   			formatter:"textarea", 
	      //   		},


























	        		
			    //     {
			    //     	id:c+2, name:"Actual",
			    //      	hours:"42",
	      //   			d1:`Cleaning: 12:00pm to 2:00pm,\nCooking: 12:00pm to 2:00pm,\nWashing the dishes: 12:00pm to 2:00pm,\nWiping the counters: 12:00pm to 2:00pm,\n12:00pm to 2:00pm,\n12:00pm to 2:00pm,\n12:00pm to 2:00pm,\n12:00pm to 2:00pm,\n`,
	      //   			d2:"Cleaning: 12:00pm to 2:00pm,\nCooking: 12:00pm to 2:00pm,\nWashing the dishes: 12:00pm to 2:00pm,\n",
	      //   			d3:"Cleaning: 12:00pm to 2:00pm,\nCooking: 12:00pm to 2:00pm,\nWashing the dishes: 12:00pm to 2:00pm,\nCleaning: 12:00pm to 2:00pm,\nCooking: 12:00pm to 2:00pm,\n",
	      //   			d4:"Cleaning: 12:00pm to 2:00pm,\n",
	      //   			d5:"Cleaning: 12:00pm to 2:00pm,\nCleaning: 12:00pm to 2:00pm,\nCleaning: 12:00pm to 2:00pm,\n",
	      //   			d6:"Cleaning: 12:00pm to 2:00pm,\nCooking: 12:00pm to 2:00pm",
	      //   			d7:"Cleaning: 12:00pm to 2:00pm,\nCooking: 12:00pm to 2:00pmCleaning: 12:00pm to 2:00pm,\nCooking: 12:00pm to 2:00pmCleaning: 12:00pm to 2:00pm,\nCooking: 12:00pm to 2:00pmCleaning: 12:00pm to 2:00pm,\nCooking: 12:00pm to 2:00pmCleaning: 12:00pm to 2:00pm,\nCooking: 12:00pm to 2:00pm",
	      //   			formatter:"textarea",}
	      //   	]
	      //   })
	      //   c += 1;
	      }
	    var tabledata = []
	    var keys = []
        var group = JSON.parse(JSON.stringify(groupBy(data,['field_57','field_58_raw.date'])))
        console.log(group)

        Object.keys(group).forEach(function (item) {
	   	Object.keys(group[item]).forEach(function (item2) {
	   		keys.push(item2)
	   		});
	   });
	   keys = Array.from(new Set(keys))
	   	Object.keys(group).forEach(function (item) {
		   	for(i of keys){
		   		if(typeof group[item][i] !== "undefined"){
		   			 var tasks_scheduled = []
		   			 var tasks_actual = []
		   			 group[item][i].forEach(function(element, index){
		   			 	tasks_scheduled.push(`${element.field_61}:${element.field_58.slice(11,)}`)
		   			 	tasks_actual.push(`${element.field_61}:${element.field_67.slice(11,)}`)
		   			 });
		   			 group[item][i][0] = tasks_scheduled.join('\n')
		   			 group[item][i][1] = tasks_actual.join('\n')
		   		}
		   	}
		});




	   	//FUCK YES -> GOLD
		function getDataFromList(grouped,item) {
			var scheduled = Object.entries(grouped[item]).map((i)=>{
				return {[i[0]]:i[1][0]}
			})
			scheduled.unshift({'name':'Scheduled'})
			scheduled =  scheduled.reduce(function(result, current) {
													  return Object.assign(result, current);
													}, {}); //Need to understand reduce
			console.log(scheduled)
			var actual = Object.entries(grouped[item]).map((i)=>{
				return {[i[0]]:i[1][0]}
			})
			actual.unshift({'name':'Actual'})
			actual =  actual.reduce(function(result, current) {
											  return Object.assign(result, current);
											}, {});	
			return [scheduled,actual]
		}
		var _id = 0; 
		console.log(group)
		for (var g of Object.keys(group)){
			tabledata.push({
				'name':g,
				'id':_id,
				'_children':getDataFromList(group,g),
				'formatter':"textarea"
			})
			_id++;
		}
	    console.log(tabledata)
		var cols = [];
		cols.push({title:"Name", field:"name"})
		cols.push({title:"Hours", field:"hours"})

		var dates_array = []; 
		var from = moment($('#from').val());
		var to = moment(from).add(7,'days')
		dates_array.push(from.toDate());
		for(i=1;i<=8;i++){
			dates_array.push(moment(from).add(i,'days'));
		}
		dates_array.forEach( function(element, index) {
			weekday = moment(element).format('dddd')
			cols.push({title:`${weekday}<br/>${moment(element).format('MM/DD')}`,
					   field:`${moment(element).format('MM/DD/YYYY')}`,
					   formatter:"textarea"})
		});
		// console.log(cols)

		var table = new Tabulator("#example-table", {
			data:tabledata,           //load row data from array
			layout:"fitColumns",      //fit columns to width of table
			responsiveLayout:"hide",  //hide columns that dont fit on the table
			resizableRows:true,
			tooltips:true,            //show tool tips on cells
			addRowPos:"top",          //when adding a new row, add it to the top of the table
			history:true,             //allow undo and redo actions on the table
			pagination:"local",       //paginate the data
			paginationSize:10000000,  
			dataTree:true,
			dataTreeStartExpanded:true,
			initialSort:[             //set the initial sort order of the data
				{column:"name", dir:"asc"},
			],
			columns: cols,
			groupBy: "name",
		});
	  };
	  $(document).ready(function() {
		$('#date-submit').on('click', function (){
			var start = moment($('#from').val());
			var end = moment(start).add(7,'days')
 			getAllRecordsForObject('scene_7', 'view_69', handleData, start = start, end = end);
		});
	  });
	</script>
	<style type="text/css" media="screen">

	</style>
</body>
</html>
